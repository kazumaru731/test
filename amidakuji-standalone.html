<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>あみだくじアプリ</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.container {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    padding: 40px;
    max-width: 900px;
    width: 100%;
}

h1 {
    color: #333;
    text-align: center;
    margin-bottom: 10px;
    font-size: 2.5em;
}

.description {
    text-align: center;
    color: #666;
    margin-bottom: 30px;
}

h2 {
    color: #444;
    margin-bottom: 20px;
    font-size: 1.5em;
}

.input-section {
    margin-bottom: 30px;
}

.participants-input {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

#participant-name {
    flex: 1;
    padding: 12px 20px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s;
}

#participant-name:focus {
    outline: none;
    border-color: #667eea;
}

button {
    padding: 12px 24px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s, transform 0.1s;
}

button:hover {
    background: #5568d3;
}

button:active {
    transform: scale(0.98);
}

.main-button {
    width: 100%;
    padding: 15px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 20px;
}

#participants-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    min-height: 40px;
}

.participant-tag {
    background: #f0f0f0;
    padding: 8px 16px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.participant-tag .remove {
    background: #ff4757;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    line-height: 1;
}

.participant-tag .remove:hover {
    background: #e84118;
}

.canvas-section {
    text-align: center;
}

#amidakuji-canvas {
    border: 2px solid #ddd;
    border-radius: 10px;
    margin: 20px auto;
    display: block;
    background: white;
    max-width: 100%;
    height: auto;
}

.results {
    margin: 20px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
}

.result-item {
    padding: 10px;
    margin: 10px 0;
    background: white;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
    color: #333;
}

.error {
    color: #ff4757;
    text-align: center;
    padding: 10px;
    margin: 10px 0;
    background: #ffe0e0;
    border-radius: 8px;
}

.select-instruction {
    text-align: center;
    color: #667eea;
    font-size: 18px;
    font-weight: bold;
    margin: 20px 0 10px 0;
}

#choice-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.choice-button {
    padding: 15px 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.choice-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

.choice-button:active {
    transform: translateY(0);
}

.choice-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* スマホ対応 */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }

    .container {
        padding: 20px;
    }

    h1 {
        font-size: 1.8em;
    }

    h2 {
        font-size: 1.2em;
    }

    .choice-button {
        padding: 12px 20px;
        font-size: 16px;
    }

    #amidakuji-canvas {
        width: 100% !important;
        height: auto !important;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <h1>あみだくじアプリ</h1>
        <p class="description">自分以外の人に必ず当たるあみだくじを作成します</p>

        <div class="input-section">
            <h2>参加者を入力</h2>
            <div class="participants-input">
                <input type="text" id="participant-name" placeholder="名前を入力（例：A）">
                <button id="add-participant">追加</button>
            </div>
            <div id="participants-list"></div>
            <button id="start-amidakuji" class="main-button">あみだくじを開始</button>
        </div>

        <div class="canvas-section" id="canvas-section" style="display: none;">
            <h2>あみだくじ</h2>
            <p class="select-instruction">クジを選んでください</p>
            <div id="choice-buttons"></div>
            <canvas id="amidakuji-canvas"></canvas>
            <div class="results" id="results"></div>
            <button id="reset" class="main-button">やり直す</button>
        </div>
    </div>

    <script>
// 参加者リスト
let participants = [];
let assignments = [];
let horizontalLinesData = [];
let canvasConfig = {};

// DOM要素
const participantNameInput = document.getElementById('participant-name');
const addParticipantBtn = document.getElementById('add-participant');
const participantsList = document.getElementById('participants-list');
const startBtn = document.getElementById('start-amidakuji');
const canvasSection = document.getElementById('canvas-section');
const canvas = document.getElementById('amidakuji-canvas');
const ctx = canvas.getContext('2d');
const resultsDiv = document.getElementById('results');
const resetBtn = document.getElementById('reset');
const choiceButtonsDiv = document.getElementById('choice-buttons');
const selectInstruction = document.querySelector('.select-instruction');

// イベントリスナー
addParticipantBtn.addEventListener('click', addParticipant);
participantNameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') addParticipant();
});
startBtn.addEventListener('click', startAmidakuji);
resetBtn.addEventListener('click', reset);

// 参加者を追加
function addParticipant() {
    const name = participantNameInput.value.trim();
    if (name && !participants.includes(name)) {
        participants.push(name);
        participantNameInput.value = '';
        renderParticipants();
    }
}

// 参加者リストを描画
function renderParticipants() {
    participantsList.innerHTML = '';
    participants.forEach((name, index) => {
        const tag = document.createElement('div');
        tag.className = 'participant-tag';
        tag.innerHTML = `
            <span>${name}</span>
            <span class="remove" onclick="removeParticipant(${index})">×</span>
        `;
        participantsList.appendChild(tag);
    });
}

// 参加者を削除
function removeParticipant(index) {
    participants.splice(index, 1);
    renderParticipants();
}

// あみだくじをたどって結果を計算
function traceAmidakuji(startCol, lines, numCols) {
    let currentCol = startCol;

    for (const line of lines) {
        if (currentCol === line.startCol) {
            currentCol = line.endCol;
        } else if (currentCol === line.endCol) {
            currentCol = line.startCol;
        }
    }

    return currentCol;
}

// 完全順列になるあみだくじを生成
function generateDerangementAmidakuji(n) {
    const maxAttempts = 1000;
    let attempts = 0;

    while (attempts < maxAttempts) {
        // 横線をランダムに生成
        const lines = [];
        const horizontalLinesCount = Math.max(10, n * 2);

        for (let i = 0; i < horizontalLinesCount; i++) {
            const startCol = Math.floor(Math.random() * (n - 1));
            lines.push({
                startCol,
                endCol: startCol + 1
            });
        }

        // 各列からたどった結果を計算
        const results = [];
        for (let i = 0; i < n; i++) {
            results[i] = traceAmidakuji(i, lines, n);
        }

        // 完全順列かチェック（誰も自分自身に当たっていない）
        let isDerangement = true;
        for (let i = 0; i < n; i++) {
            if (i === results[i]) {
                isDerangement = false;
                break;
            }
        }

        if (isDerangement) {
            // 完全順列が見つかった
            return { lines, results };
        }

        attempts++;
    }

    return null;
}

// レスポンシブ対応のキャンバスサイズを計算
function calculateCanvasSize(n) {
    const containerWidth = document.querySelector('.container').offsetWidth;
    const maxWidth = Math.min(containerWidth - 40, 900);

    // スマホ対応
    const isMobile = window.innerWidth <= 768;
    const canvasWidth = isMobile ? maxWidth : Math.max(600, n * 120);
    const canvasHeight = isMobile ? 400 : 500;

    return { width: canvasWidth, height: canvasHeight };
}

// あみだくじを開始
function startAmidakuji() {
    if (participants.length < 2) {
        alert('参加者は2人以上必要です');
        return;
    }

    const amidakujiData = generateDerangementAmidakuji(participants.length);

    if (!amidakujiData) {
        alert('あみだくじの生成に失敗しました。もう一度お試しください。');
        return;
    }

    // 結果のマッピングを保存
    assignments = amidakujiData.results;

    document.querySelector('.input-section').style.display = 'none';
    canvasSection.style.display = 'block';

    drawAmidakuji(participants, amidakujiData.lines);
    createChoiceButtons();
}

// 選択ボタンを生成
function createChoiceButtons() {
    choiceButtonsDiv.innerHTML = '';
    selectInstruction.style.display = 'block';
    resultsDiv.style.display = 'none';

    participants.forEach((name, index) => {
        const button = document.createElement('button');
        button.className = 'choice-button';
        button.textContent = name;
        button.onclick = () => startAnimation(index);
        choiceButtonsDiv.appendChild(button);
    });
}

// あみだくじを描画
function drawAmidakuji(start, lines) {
    const n = start.length;
    const size = calculateCanvasSize(n);
    canvas.width = size.width;
    canvas.height = size.height;

    const padding = 60;
    const lineSpacing = (size.width - 2 * padding) / (n - 1);
    const verticalStart = 60;
    const verticalEnd = size.height - 60;

    // 設定を保存
    canvasConfig = {
        n,
        padding,
        lineSpacing,
        verticalStart,
        verticalEnd
    };

    // 横線にY座標を割り当て
    horizontalLinesData = [];
    const horizontalSpacing = (verticalEnd - verticalStart) / (lines.length + 1);

    lines.forEach((line, index) => {
        horizontalLinesData.push({
            y: verticalStart + (index + 1) * horizontalSpacing,
            startCol: line.startCol,
            endCol: line.endCol
        });
    });

    // 描画
    redrawCanvas(start);
}

// キャンバスを再描画
function redrawCanvas(start, highlightCol = -1, currentY = -1) {
    const { n, padding, lineSpacing, verticalStart, verticalEnd } = canvasConfig;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 3;
    ctx.font = 'bold 16px sans-serif';
    ctx.textAlign = 'center';

    // 縦線を描画
    for (let i = 0; i < n; i++) {
        const x = padding + i * lineSpacing;

        // 上部の名前
        ctx.fillStyle = '#667eea';
        ctx.fillText(start[i], x, verticalStart - 30);

        // 縦線
        ctx.strokeStyle = '#ddd';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x, verticalStart);
        ctx.lineTo(x, verticalEnd);
        ctx.stroke();

        // 下部の名前（上部と同じ順序）
        ctx.fillStyle = '#764ba2';
        ctx.fillText(start[i], x, verticalEnd + 30);
    }

    // 横線を描画
    horizontalLinesData.forEach(line => {
        const x1 = padding + line.startCol * lineSpacing;
        const x2 = padding + line.endCol * lineSpacing;

        ctx.strokeStyle = '#ff6b6b';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x1, line.y);
        ctx.lineTo(x2, line.y);
        ctx.stroke();
    });

    // 現在の位置をハイライト
    if (highlightCol >= 0 && currentY >= 0) {
        const x = padding + highlightCol * lineSpacing;
        ctx.fillStyle = '#ff6b6b';
        ctx.beginPath();
        ctx.arc(x, currentY, 8, 0, Math.PI * 2);
        ctx.fill();
    }
}

// アニメーション開始
function startAnimation(startIndex) {
    // ボタンを無効化
    const buttons = document.querySelectorAll('.choice-button');
    buttons.forEach(btn => btn.disabled = true);
    selectInstruction.style.display = 'none';

    let currentCol = startIndex;
    let currentY = canvasConfig.verticalStart;
    const speed = 3;
    let lineIndex = 0;

    function animate() {
        const { padding, lineSpacing, verticalStart, verticalEnd } = canvasConfig;

        // 現在の位置を更新
        currentY += speed;

        // 横線との交差チェック
        while (lineIndex < horizontalLinesData.length) {
            const line = horizontalLinesData[lineIndex];

            if (Math.abs(currentY - line.y) < speed) {
                // 横線に到達
                if (currentCol === line.startCol) {
                    currentCol = line.endCol;
                } else if (currentCol === line.endCol) {
                    currentCol = line.startCol;
                }
                lineIndex++;
                break;
            } else if (currentY < line.y) {
                break;
            } else {
                lineIndex++;
            }
        }

        // 再描画
        redrawCanvas(participants, currentCol, currentY);

        // アニメーション継続判定
        if (currentY < verticalEnd) {
            requestAnimationFrame(animate);
        } else {
            // アニメーション終了
            showResult(startIndex, currentCol);
        }
    }

    animate();
}

// 結果を表示
function showResult(startIndex, endIndex) {
    resultsDiv.style.display = 'block';
    const resultName = participants[endIndex];
    resultsDiv.innerHTML = `
        <h3>結果</h3>
        <div class="result-item" style="font-size: 24px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            ${participants[startIndex]} → ${resultName}
        </div>
    `;

    // 検証
    if (participants[startIndex] === resultName) {
        resultsDiv.innerHTML += `
            <div class="error">エラー: 同じ人に当たっています。もう一度やり直してください。</div>
        `;
    }

    // ボタンを有効化
    const buttons = document.querySelectorAll('.choice-button');
    buttons.forEach(btn => btn.disabled = false);
    selectInstruction.style.display = 'block';
    selectInstruction.textContent = 'もう一度選ぶ、またはやり直してください';
}

// リセット
function reset() {
    document.querySelector('.input-section').style.display = 'block';
    canvasSection.style.display = 'none';
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    resultsDiv.innerHTML = '';
    choiceButtonsDiv.innerHTML = '';
    selectInstruction.style.display = 'block';
    selectInstruction.textContent = 'クジを選んでください';
    horizontalLinesData = [];
    assignments = [];
}
    </script>
</body>
</html>
